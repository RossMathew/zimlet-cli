{"version":3,"sources":["../src/index.js"],"names":["run","configure","args","callback","package","packageZimlet","config","compiler","plugin","console","error","err","stack","details","info","stats","toJson","hasErrors","process","stdout","write","red","errors","forEach","hasWarnings","warnings","warn","green","devServer","https","host","port","protocol","serverAddr","bold","localIpAddr","address","listen","length","env","watch","w","NODE_ENV","PROD","HTTPS","HOST","PORT","cwd","context","pkg","require","resolve","e","main","entry","module","isDir","dest","componentDirs","cssLoaderOptions","autoprefixer","sourceMap","postCssLoaderOptions","plugins","browsers","removeAll","cssModulesRegexp","webpackConfig","__dirname","output","path","filename","chunkFilename","publicPath","extensions","mainFields","modules","alias","preact","react","style","resolveLoader","rules","test","loader","options","babelrc","comments","presets","loose","pragma","include","use","importLoaders","localIdentRegExp","localIdentName","exclude","node","Buffer","__filename","setImmediate","concat","NoEmitOnErrorsPlugin","HashedModuleIdsPlugin","optimize","ModuleConcatenationPlugin","UglifyJsPlugin","NamedModulesPlugin","HotModuleReplacementPlugin","LoaderOptionsPlugin","minimize","debug","format","renderThrottle","summary","DefinePlugin","JSON","stringify","watchOptions","ignored","devtool","hot","DISABLE_HOT","compress","contentBase","disableHostCheck","before","app","maxAge","overlay","noInfo","quiet","builddir","name","xmlFile","zimletXML","description","readdir","files","file","match","writeFile","zipFile","addLocalFolder","writeZip","filepath","statSync","isDirectory"],"mappings":"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","file":"index.js","sourcesContent":["\n\nimport fs from 'fs';\nimport path from 'path';\nimport ip from 'ip';\nimport chalk from 'chalk';\nimport webpack from 'webpack';\nimport WebpackDevServer from 'webpack-dev-server';\nimport clearConsole from 'console-clear';\nimport ProgressBarPlugin from 'progress-bar-webpack-plugin';\nimport cssnext from 'postcss-cssnext';\nimport discardComments from 'postcss-discard-comments';\nimport Zip from 'adm-zip';\nimport { crossPlatformPathRegex } from './util';\n\nexport default function run(args, callback) {\n\n\t//if it is just package, then package appropriately\n\tif (args.package) {\n\t\treturn packageZimlet(args, callback);\n\t}\n\n\tlet config = configure(args);\n\n\tlet compiler = webpack(config);\n\n\tcompiler.plugin('failed', err => {\n\t\tconsole.error(err.stack || err);\n\t\tif (err.details) console.error(err.details);\n\t});\n\n\tcompiler.plugin('done', stats => {\n\t\tlet info = stats.toJson();\n\n\t\tif (stats.hasErrors()) {\n\t\t\tprocess.stdout.write(chalk.red('Build failed!\\n\\n'));\n\t\t\tinfo.errors.forEach(err => console.error(err));\n\t\t}\n\t\telse {\n\t\t\tclearConsole();\n\n\t\t\tif (stats.hasWarnings()) {\n\t\t\t\tinfo.warnings.forEach(err => console.warn(err));\n\t\t\t}\n\n\t\t\tprocess.stdout.write(chalk.green('Compiled successfully!\\n\\n'));\n\n\t\t\tif (config.devServer) {\n\t\t\t\tlet { https, host, port } = config.devServer;\n\t\t\t\tlet protocol = https ? 'https' : 'http';\n\t\t\t\tif (host === '0.0.0.0') host = 'localhost';\n\t\t\t\tlet serverAddr = `${protocol}://${host}:${chalk.bold(port)}/index.js`;\n\t\t\t\tlet localIpAddr = `${protocol}://${ip.address()}:${chalk.bold(port)}/index.js`;\n\n\t\t\t\tprocess.stdout.write('You can view the application in browser.\\n\\n');\n\t\t\t\tprocess.stdout.write(`${chalk.bold('Local:')}            ${serverAddr}\\n`);\n\t\t\t\tprocess.stdout.write(`${chalk.bold('On Your Network:')}  ${localIpAddr}\\n`);\n\t\t\t}\n\t\t}\n\t});\n\n\tif (config.devServer) {\n\t\tnew WebpackDevServer(compiler, config.devServer).listen(config.devServer.port);\n\t}\n\telse {\n\t\tcompiler.run( (err, stats) => {\n\t\t\tif (!err && stats.hasErrors()) {\n\t\t\t\terr = `${stats.toJson().errors.length} errors`;\n\t\t\t}\n\t\t\tcallback(err, null);\n\t\t});\n\t}\n}\n\nexport function configure(env) {\n\tenv = env || {};\n\tconst watch = env.watch || env.w || process.env.NODE_ENV === 'dev' || process.env.NODE_ENV === 'development';\n\tconst PROD = !watch;\n\n\tlet https = !(process.env.HTTPS === 'false' || env.https === false),\n\t\thost = process.env.HOST || env.host || 'localhost',\n\t\tport = process.env.PORT || env.port || 8081;\n\n\tlet cwd = process.cwd(),\n\t\tcontext = cwd,\n\t\tpkg;\n\n\ttry {\n\t\tpkg\t= require(path.resolve(cwd, 'package.json'));\n\t}\n\tcatch (e) {}\n\n\tif (!pkg) {\n\t\tpkg = { main: 'index.js' };\n\n\t}\n\n\t// entry point (initial file to load)\n\tlet entry = path.resolve(cwd, pkg.module || pkg['jsnext:main'] || pkg.main);\n\tif (isDir(entry)) entry = path.resolve(entry, 'index.js');\n\n\t// attempt to use ./src dir if present:\n\tif (isDir(path.resolve(cwd, 'src'))) context = path.resolve(context, 'src');\n\n\n\t// normalize desination dir\n\tlet dest = path.resolve(cwd, env.dest || 'build');\n\n\t// use absolute paths\n\tcontext = path.resolve(context);\n\n\tlet componentDirs = [\n\t\tpath.resolve(context, 'components'),\n\t\tpath.resolve(context, 'screens'),\n\t\tpath.resolve(context, 'pages')\n\t];\n\n\tlet cssLoaderOptions = {\n\t\tautoprefixer: false,\n\t\tsourceMap: watch && !PROD\n\t};\n\n\tlet postCssLoaderOptions = {\n\t\tplugins: [\n\t\t\tcssnext({ browsers: ['last 2 versions', 'ie >= 11', 'iOS >= 8'] }),\n\t\t\tdiscardComments({ removeAll: true })\n\t\t]\n\t};\n\n\tlet cssModulesRegexp = crossPlatformPathRegex(/(?:([^/@]+?)(?:-(?:pages?|components?|screens?))?\\/)?src\\/(?:pages|components|screens)\\/(.+?)(\\/[a-z0-9._-]+[.](less|css))?$/);\n\n\tlet webpackConfig = {\n\t\tcontext,\n\t\tentry: path.resolve(__dirname, 'entry.js'),\n\n\t\toutput: {\n\t\t\tpath: dest,\n\t\t\tfilename: `index.js`,\n\t\t\tchunkFilename: '[name].[chunkhash:8].chunk.js',\n\t\t\t// NOTE: Explicit public path is required in order to make HMR work within an sourceless iframe.\n\t\t\t// This is due to a bug in webpack-dev-server that uses the document protocol for all https pages:\n\t\t\t// https://github.com/webpack/webpack-dev-server/blob/c490b245ad65f315762e03e51710f7f7177b1e7b/client/index.js#L188-L190\n\t\t\tpublicPath: watch ? `http${https?'s':''}://${host}:${port}/` : '/'\n\t\t},\n\n\t\tresolve: {\n\t\t\textensions: ['.jsx', '.js', '.json', '.css', '.less'],\n\t\t\tmainFields: ['browser', 'module', 'jsnext:main', 'main'],\n\t\t\tmodules: [\n\t\t\t\tpath.resolve(cwd, 'node_modules'),\n\t\t\t\tpath.resolve(__dirname, '..', 'node_modules'),\n\t\t\t\tpath.resolve(__dirname, '../../..'), // Resolves to the `packages` directory\n\t\t\t\t'node_modules'\n\t\t\t],\n\n\t\t\talias: {\n\t\t\t\tpreact: path.resolve(__dirname, 'preact.js'),\n\t\t\t\treact: 'preact',\n\t\t\t\t'react-dom': 'preact-compat',\n\t\t\t\tstyle: path.resolve(context, 'style'),\n\t\t\t\t'zimlet-cli-entrypoint': path.resolve(context, entry)\n\t\t\t}\n\t\t},\n\n\t\tresolveLoader: {\n\t\t\tmodules: [\n\t\t\t\tpath.resolve(__dirname, 'loaders'),\n\t\t\t\tpath.resolve(__dirname, '..', 'node_modules'),\n\t\t\t\tpath.resolve(cwd, 'node_modules')\n\t\t\t]\n\t\t},\n\n\t\tmodule: {\n\t\t\trules: [\n\t\t\t\t{\n\t\t\t\t\ttest: /\\.jsx?$/,\n\t\t\t\t\tloader: 'babel-loader',\n\t\t\t\t\toptions: {\n\t\t\t\t\t\tbabelrc: false,\n\t\t\t\t\t\tcomments: false,\n\t\t\t\t\t\tpresets: [\n\t\t\t\t\t\t\t[require.resolve('babel-preset-env'), { loose: true, modules: false }],\n\t\t\t\t\t\t\trequire.resolve('babel-preset-stage-0')\n\t\t\t\t\t\t],\n\t\t\t\t\t\tplugins: [\n\t\t\t\t\t\t\trequire.resolve('babel-plugin-transform-decorators-legacy'),\n\t\t\t\t\t\t\trequire.resolve('babel-plugin-transform-object-assign'),\n\t\t\t\t\t\t\t[require.resolve('babel-plugin-transform-react-jsx'), { pragma: 'preact.h' }]\n\t\t\t\t\t\t]\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttest: /\\.(less|css)$/,\n\t\t\t\t\t// include: /(^|\\/)src\\/(?:components|screens)\\//,\n\t\t\t\t\tinclude: componentDirs,\n\t\t\t\t\tuse: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tloader: path.resolve(__dirname, 'zimlet-style-loader.js')\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tloader: 'css-loader',\n\t\t\t\t\t\t\toptions: {\n\t\t\t\t\t\t\t\t...cssLoaderOptions,\n\t\t\t\t\t\t\t\tmodules: true,\n\t\t\t\t\t\t\t\timportLoaders: 1,\n\t\t\t\t\t\t\t\tlocalIdentRegExp: cssModulesRegexp,\n\t\t\t\t\t\t\t\tlocalIdentName: '[1]_[2]_[local]'\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tloader: 'postcss-loader',\n\t\t\t\t\t\t\toptions: postCssLoaderOptions\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tloader: 'less-loader'\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttest: /\\.(less|css)$/,\n\t\t\t\t\t// exclude: /(^|\\/)src\\/(?:components|screens)\\//,\n\t\t\t\t\texclude: componentDirs,\n\t\t\t\t\tuse: [\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tloader: path.resolve(__dirname, 'zimlet-style-loader.js')\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tloader: 'css-loader',\n\t\t\t\t\t\t\toptions: cssLoaderOptions\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tloader: 'postcss-loader',\n\t\t\t\t\t\t\toptions: postCssLoaderOptions\n\t\t\t\t\t\t},\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tloader: 'less-loader'\n\t\t\t\t\t\t}\n\t\t\t\t\t]\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttest: /\\.(xml|html|txt|md)$/,\n\t\t\t\t\tloader: 'raw-loader'\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\ttest: /\\.(svg|ttf|woff2?|eot|otf|jpe?g|png|gif)$/i,\n\t\t\t\t\tloader: watch ? 'url-loader' : 'file-loader'\n\t\t\t\t}\n\t\t\t]\n\t\t},\n\n\t\tnode: PROD ? {\n\t\t\tconsole: false,\n\t\t\tBuffer: false,\n\t\t\t__filename: false,\n\t\t\t__dirname: false,\n\t\t\tsetImmediate: false\n\t\t} : {},\n\n\t\tplugins: [].concat(\n\t\t\tPROD ? [\n\t\t\t\tnew webpack.NoEmitOnErrorsPlugin(),\n\t\t\t\tnew webpack.HashedModuleIdsPlugin(),\n\t\t\t\tnew webpack.optimize.ModuleConcatenationPlugin(),\n\t\t\t\tnew webpack.optimize.UglifyJsPlugin()\n\t\t\t] : [\n\t\t\t\tnew webpack.NamedModulesPlugin(),\n\t\t\t\tnew webpack.HotModuleReplacementPlugin()\n\t\t\t],\n\n\t\t\tnew webpack.LoaderOptionsPlugin({\n\t\t\t\tminimize: PROD,\n\t\t\t\tdebug: !PROD\n\t\t\t}),\n\n\t\t\tnew ProgressBarPlugin({\n\t\t\t\tformat: '\\u001b[90m\\u001b[44mBuild\\u001b[49m\\u001b[39m [:bar] \\u001b[32m\\u001b[1m:percent\\u001b[22m\\u001b[39m (:elapseds) \\u001b[2m:msg\\u001b[22m',\n\t\t\t\trenderThrottle: 100,\n\t\t\t\tsummary: false\n\t\t\t}),\n\n\t\t\tnew webpack.DefinePlugin({\n\t\t\t\t'process.env.NODE_ENV': JSON.stringify(PROD?'production':'development')\n\t\t\t})\n\t\t),\n\n\t\twatchOptions: {\n\t\t\tignored: [\n\t\t\t\t'build',\n\t\t\t\tdest,\n\t\t\t\tpath.resolve(cwd, 'node_modules')\n\t\t\t]\n\t\t},\n\n\t\tstats: 'errors-only',\n\n\t\tdevtool: watch ? 'cheap-module-eval-source-map' : 'source-map'\n\t};\n\n\tif (watch) {\n\t\twebpackConfig.entry = [\n\t\t\twebpackConfig.entry,\n\t\t\t`webpack-dev-server/client?${https ? 'https' : 'http'}://${host}:${port}/`,\n\t\t\t`webpack/hot/dev-server?${https ? 'https' : 'http'}://${host}:${port}/`\n\t\t];\n\n\t\twebpackConfig.devServer = {\n\t\t\thost,\n\t\t\tport,\n\t\t\thot: !process.env.DISABLE_HOT,\n\t\t\thttps,\n\t\t\tcompress: true,\n\t\t\tpublicPath: '/',\n\t\t\tcontentBase: context,\n\t\t\tdisableHostCheck: true,\n\t\t\tbefore(app) {\n\t\t\t\tapp.use(require('cors')({\n\t\t\t\t\tmaxAge: 3600\n\t\t\t\t}));\n\t\t\t},\n\t\t\twatchOptions: {\n\t\t\t\tignored: [\n\t\t\t\t\t'build',\n\t\t\t\t\tdest,\n\t\t\t\t\tpath.resolve(cwd, 'node_modules')\n\t\t\t\t]\n\t\t\t},\n\t\t\toverlay: false,\n\t\t\tnoInfo: true,\n\t\t\tquiet: true,\n\t\t\tstats: 'errors-only'\n\t\t};\n\t}\n\n\treturn webpackConfig;\n}\n\nfunction packageZimlet(args, callback) {\n\n\t// normalize built files source directory and desination package dir\n\tlet cwd = process.cwd();\n\tlet builddir = path.resolve(cwd, args.builddir || 'build');\n\tlet dest = path.resolve(cwd, args.dest || 'pkg', `${args.name}.zip`);\n\n\t//Create the xml descriptor file for the zimlet\n\tlet xmlFile = `${args.name}.xml`;\n\n\tlet zimletXML = `<zimlet name=\"${args.name}\" version=\"${args['pkg-version']}\" description=\"${args.description}\">`;\n\n\tfs.readdir(builddir, (err, files) => {\n\t\tfiles.forEach(file => {\n\t\t\tif (file.match(/\\.js$/)) {\n\t\t\t\tzimletXML += `\\n\\t<include>${file}</include>`;\n\t\t\t}\n\t\t\telse if (file.match(/\\.css$/)) {\n\t\t\t\tzimletXML += `\\n\\t<includeCSS>${file}</includeCSS>`;\n\t\t\t}\n\t\t\telse if (file !== xmlFile) {\n\t\t\t\tzimletXML += `\\n\\t<resource>${file}</resource>`;\n\t\t\t}\n\t\t});\n\n\t\tzimletXML += '\\n</zimlet>';\n\n\t\tfs.writeFile(path.resolve(builddir, xmlFile), zimletXML,\n\t\t\t(err) => {\n\t\t\t\tif (err) {\n\t\t\t\t\treturn callback('Failed to write XML file: ' + err);\n\t\t\t\t}\n\n\t\t\t\t//Zip up the contents of the build dir along with the xml file as the final zimlet deliverable\n\t\t\t\tlet zipFile = new Zip();\n\t\t\t\tzipFile.addLocalFolder(builddir, '');\n\t\t\t\tzipFile.writeZip(dest);\n\n\t\t\t\treturn callback(null, `Successfully packaged zimlet to: ${dest}\\n`);\n\t\t\t});\n\t});\n\n}\n\nfunction isDir(filepath) {\n\ttry {\n\t\treturn !!fs.statSync(filepath).isDirectory();\n\t}\n\tcatch (err) { }\n}\n"]}